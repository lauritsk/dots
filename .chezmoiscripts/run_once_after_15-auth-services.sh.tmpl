#!/usr/bin/env bash
set -euo pipefail

echo "üîì Setting up service authentication..."

# Initialize mise if available
if command -v mise >/dev/null 2>&1; then
    eval "$(mise activate bash)"
fi

# Atuin setup
echo "üîì Attempting to log into Atuin..."

if mise exec -- sh -c 'atuin login \
  --username "$ATUIN_USERNAME" \
  --password "$ATUIN_PASSWORD" \
  --key "$ATUIN_KEY"'; then
    echo "‚úÖ Successfully signed into atuin!"
else
    echo "‚ö†Ô∏è  Login command exited with error. Assuming already logged in..."
fi

echo "üîÑ Syncing Atuin..."
atuin sync

# Tailscale setup
echo "üîì Logging into Tailscale..."
if command -v tailscale >/dev/null 2>&1; then
    if [ -n "${TS_AUTH_KEY:-}" ]; then
        sudo tailscale up --auth-key "$TS_AUTH_KEY"
        echo "‚úÖ Successfully signed into Tailscale!"
        echo "üîÑ Confirming Tailscale status..."
        tailscale status
    else
        echo "‚ö†Ô∏è  TS_AUTH_KEY not found. Skipping Tailscale login."
    fi
else
    echo "‚ö†Ô∏è  Tailscale not found. Skipping setup."
fi

echo "‚úÖ Service authentication complete!"