#!/usr/bin/env bash
set -euo pipefail

echo "üåç Activating Homebrew environment..."
eval "$("$BREW_PREFIX/bin/brew" shellenv)"

if [[ -f "$HOME/.config/homebrew/Brewfile" ]]; then
    echo "üì¶ Running Homebrew Bundle..."
    brew bundle --file="$HOME/.config/homebrew/Brewfile"
else
    echo "‚ö†Ô∏è  No Brewfile found. Skipping bundle."
fi

if [[ -f "$HOME/.config/mise/config.toml" ]]; then
    echo "üì¶  Installing Mise packages..."
    mise install
else
    echo "‚ö†Ô∏è  No mise config file found. Skipping mise install."
fi

if FISH_PATH="$(command -v fish)"; then
    echo "üê† Configuring Fish shell..."
    echo "   Found at: $FISH_PATH"

    if ! grep -q "$FISH_PATH" /etc/shells; then
        echo "   Adding to /etc/shells..."
        echo "$FISH_PATH" | sudo tee -a /etc/shells >/dev/null
    fi

    if [[ "$SHELL" != "$FISH_PATH" ]]; then
        echo "   Changing default shell to Fish..."
        sudo chsh -s "$FISH_PATH" "$USER"
    else
        echo "   Fish is already the default shell."
    fi
else
    echo "‚ö†Ô∏è  Fish command not found in PATH."
fi

echo "‚úÖ Setup complete!"

echo "Now sign in to atuin manually..."
