#!/usr/bin/env bash
set -euo pipefail

source "{{ .chezmoi.homeDir }}/.bashrc"

# cd {{ .chezmoi.sourceDir }}

# if atuin status | grep -q "Username:"; then
#     echo "âœ… Atuin is already logged in."
# else
#     echo "ğŸ”“ Logging into Atuin..."
#     fnox exec -- sh -c 'atuin login \
#       --username "$ATUIN_USERNAME" \
#       --password "$ATUIN_PASSWORD" \
#       --key "$ATUIN_KEY"'
#     echo "âœ… Successfully signed into atuin!"
# fi

# echo "ğŸ”„ Syncing Atuin..."
# atuin sync

# echo "âœ… Atuin setup complete!"


# This is the more unreliable method until atuin status command gets fixed...

cd "{{ .chezmoi.sourceDir }}"

echo "ğŸ”“ Attempting to log into Atuin..."

if fnox exec -- sh -c 'atuin login \
  --username "$ATUIN_USERNAME" \
  --password "$ATUIN_PASSWORD" \
  --key "$ATUIN_KEY"'; then
    echo "âœ… Successfully signed into atuin!"
else
    echo "âš ï¸  Login command exited with error. Assuming already logged in..."
fi

cd "{{ .chezmoi.homeDir }}"

echo "ğŸ”„ Syncing Atuin..."
atuin sync

echo "âœ… Atuin setup complete!"
